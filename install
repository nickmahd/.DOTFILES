#!/bin/bash

# nickmahda@gmail.com

cd "$(dirname "${BASH_SOURCE[0]}")" || exit 1

DIR=$(pwd)

git submodule update --init --recursive --remote

while getopts "pcb" o; do
    case "$o" in
        p) p=1;;
        c) c=1;;
        b) b=1;;
    esac
done

bacup() { { [ -e ~/."$1" ] || [ -d ~/."$1" ] } && { mkdir -pv $DIR/backup; mv -v ~/."$1" $DIR/backup/"$1"; } }

mov () {
    bacup $1
    ln -sfv "$DIR/$1" ~/."$1"
}

for f in vars zshrc gitconfig tmux.conf.local p10k.zsh; do
    f=$(sed "s/\.//" "$f")
    cmp --silent ~/."$f" "$f" || mov $f
done

cd tmux || exit

mov .tmux.conf

cd .. || exit

![ "$b" ] || bacup bashrc
echo -e "[ -f ~/.vars ] && source ~/.vars" >> ~/.bashrc

bacup zsh
ln -sfv "$DIR/zsh" ~/.zsh

if [[ "$OSTYPE" == "darwin"* ]]; then
    bacup bash_profile
    echo -e "[ -f ~/.bashrc ] && source ~/.bashrc" > ~/.bash_profile

    if [ -z "$(which brew)" ]; then
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
        sudo chown -R "$(whoami)" "$(brew --prefix)"/*
    fi

    [ "$p" ] && brew install coreutils gcc nano pkg-config python tmux vim youtube-dl zsh # cmake emacs gnu-chess htop nginx opencv tree

    [ "$c" ] && brew cask install apple-juice discord dozer eqmac flux google-backup-and-sync google-chrome iterm2 karabiner-elements overkill selfcontrol slack spotify the-unarchiver telegram visual-studio-code # appcleaner docker eqmac firefox gimp latest omnidisksweeper ticktick vnc-viewer zotero

    cp "$DIR"/BlexMono.ttf ~/Library/Fonts/

    [ "$c" ] && /usr/local/bin/pip3 install -r "$DIR"/requirements.txt

elif [[ "$OSTYPE" == "linux"* ]]; then
    [ "$p" ] && sudo apt install git pkg-config python3-pip tmux vim zsh # emacs htop gnuchess

    [ "$c" ] && /usr/bin/pip3 install -r "$DIR"/requirements.txt
fi

sudo ln -sfv "$DIR"/zsh/powerlevel10k/powerlevel10k.zsh-theme /usr/local/share/zsh/site-functions/prompt_powerlevel10k_setup

touch ~/.path
touch ~/.vars.local

echo "Moving to vim install"

cd "$DIR" || exit
./viminstall
